{% extends "sentry/bases/settings.html" %}

{% load crispy_forms_tags %}
{% load i18n %}
{% load sentry_features %}
{% load sentry_helpers %}
{% load sentry_plugins %}

{% block wrapperclass %} {{ block.super }} show-rightbar settings{% endblock %}

{% block controller %}ManageProjectCtrl{% endblock %}

{% block header_action %}
  <ul class="nav nav-tabs">
    <li>
      <a href="{% url 'sentry-stream' project.organization.slug project.slug %}">Stream</a>
    </li>
    <li>
      <a href="{% url 'sentry-releases' project.organization.slug project.slug %}">Releases</a>
    </li>
    <li class="active">
      <a href="{% url 'sentry-manage-project' project.organization.slug project.slug %}">Settings</a>
    </li>
  </ul>
{% endblock %}

{% block content %}
  <h3>{% trans "Project Settings" %}</h3>
  <form class="form-stacked" action="." method="post" id="project_settings">
    {% csrf_token %}

    {{ form|as_crispy_errors }}

    <div class="box">
      <div class="box-header">
        <h3>{% trans "Project Details" %}</h3>
      </div>
      <div class="box-content with-padding">
        {{ form.name|as_crispy_field }}
        {{ form.slug|as_crispy_field }}
        {{ form.platform|as_crispy_field }}
        {{ form.team|as_crispy_field }}
      </div>
    </div>

    <div class="box">
      <div class="box-header">
        <h3>{% trans "Event Settings" %}</h3>
      </div>
      <div class="box-content with-padding">
        {{ form.resolve_age|as_crispy_field }}
        {{ form.scrub_data|as_crispy_field }}
        {{ form.sensitive_fields|as_crispy_field }}
        {{ form.scrub_ip_address|as_crispy_field }}
        {% if form.public %}
        {{ form.public|as_crispy_field }}
        {% endif %}
      </div>
    </div>

    <div class="box">
      <div class="box-header">
        <h3>{% trans "Client Security" %}</h3>
      </div>
      <div class="box-content with-padding">
        {% with form.origins as field %}
        <p>{% blocktrans with 'https://github.com/getsentry/raven-js' as link %}Configure origin URLs which Sentry should accept events from. This is used for communication with clients like <a href="{{ link }}">raven-js</a>.{% endblocktrans %}
        <br>
        {% blocktrans %}This will restrict requests based on the <code>Origin</code> and <code>Referer</code> headers.{% endblocktrans %}</p>
        {{ field|as_crispy_field }}
        {% endwith %}
        {{ form.token|as_crispy_field }}
      </div>
    </div>

    <div class="box">
      <div class="box-header">
        <h3>{% trans "Remove Project" %}</h3>
      </div>
      <div class="box-content with-padding">
        {% if not ACCESS.project_delete %}
        <p>{% trans "You do not have the required permission to remove this project." %}</p>
        {% elif project.is_internal_project %}
        <p>{% trans "This project cannot be removed. It is used internally by the Sentry server." %}</p>
        {% else %}
        <p class="clearfix">
          <a href="{% url 'sentry-remove-project' project.organization.slug project.slug %}" class="btn btn-danger pull-right">{% trans "Remove Project" %}</a>
          Remove the <strong>{{ project.slug }}</strong> project from <strong>{{ project.team.slug }}</strong>. </br>
          Careful, this action cannot be undone.
        </p>
        {% endif %}
      </div>
    </div>

    <div class="form-actions">
      <button type="submit" class="btn btn-primary btn-lg">{% trans "Save Changes" %}</button>
    </div>
  </form>

  <script>
  (function(){
    var formatHours = function(val) {
      val = parseInt(val, 10);
      if (val === 0) {
          return 'Disabled';
      } else if (val > 23 && val % 24 === 0) {
          val = (val / 24);
          return val + ' day' + (val != 1 ? 's' : '');
      }
      return val + ' hour' + (val != 1 ? 's' : '');
    }

    $("input[type=range]").each(function(n, el){
      var $el = $(el),
          min = parseInt($el.attr('min'), 10),
          max = parseInt($el.attr('max'), 10),
          step = parseInt($el.attr('step'), 10),
          values = [],
          $value = $('<span class="value"></span>');

      var i = min;
      while (i <= max) {
        values.push(i);
        if (i < 12) {
          i += 1;
        } else if (i < 24) {
          i += 3;
        } else if (i < 36) {
          i += 6;
        } else if (i < 48) {
          i += 12;
        } else {
          i += 24;
        }
      }

      $el.on("slider:ready", function(event, data) {
        $value.appendTo(data.el);
        $value.html(formatHours(data.value));
      }).on("slider:changed", function(event, data) {
        $value.html(formatHours(data.value));
      }).simpleSlider({
        range: [min, max],
        step: step,
        allowedValues: values,
        snap: true
      });
    });
  }());
  </script>
{% endblock %}

{% block rightbar %}
  <h6>{% trans "Configuration" %}</h6>
  <ul class="nav nav-stacked">
    <li{% if not page %} class="active"{% endif %}>
        <a href="{% url 'sentry-manage-project' project.organization.slug project.slug %}">{% trans "Project Settings" %}</a>
    </li>
    <li{% if page == 'notifications' %} class="active"{% endif %}>
        <a href="{% url 'sentry-project-notifications' project.organization.slug project.slug %}">{% trans "Notifications" %}</a>
    </li>
    {% feature projects:quotas project %}
    <li{% if page == 'quotas' %} class="active"{% endif %}>
        <a href="{% url 'sentry-manage-project-quotas' project.organization.slug project.slug %}">{% trans "Rate Limits" %}</a>
    </li>
    {% endfeature %}
    <li{% if page == 'rules' %} class="active"{% endif %}>
        <a href="{% url 'sentry-project-rules' project.organization.slug project.slug %}">{% trans "Rules" %}</a>
    </li>
    <li{% if page == 'tags' %} class="active"{% endif %}>
        <a href="{% url 'sentry-manage-project-tags' project.organization.slug project.slug %}">{% trans "Tags" %}</a>
    </li>
    <li{% if page == 'issue-tracking' %} class="active"{% endif %}>
        <a href="{% url 'sentry-project-issue-tracking' project.organization.slug project.slug %}">{% trans "Issue Tracking" %}</a>
    </li>
    {% feature projects:release-tracking project %}
    <li{% if page == 'release-tracking' %} class="active"{% endif %}>
        <a href="{% url 'sentry-project-release-tracking' project.organization.slug project.slug %}">{% trans "Release Tracking" %}</a>
    </li>
    {% endfeature %}
    <li{% if page == 'keys' %} class="active"{% endif %}>
        <a href="{% url 'sentry-manage-project-keys' project.organization.slug project.slug %}">{% trans "Client Keys" %}</a>
    </li>
  </ul>
  <h6>{% trans "Help" %}</h6>
  <ul class="nav nav-stacked">
    <li>
        <a href="{% url 'sentry-help-platform-list' %}?pid={{ project.id }}">{% trans "Setup &amp; Installation" %}</a>
    </li>
    {% with project|get_plugins as plugins %}
      <h6>{% trans "Integrations" %}</h6>
      <ul class="nav nav-stacked">
        <li class="{% if page == 'plugins' %} active{% endif %}">
          <a href="{% url 'sentry-manage-project-plugins' project.organization.slug project.slug %}">{% trans "Manage Integrations" %} ({{ PLUGINS|length }})</a>
        </li>
      {% for p in plugins %}
        <li{% if page == 'plugin' and plugin.slug == p.slug %} class="active"{% endif %}>
            <a href="{% url 'sentry-configure-project-plugin' project.organization.slug project.slug p.slug %}">{{ p.get_title }}</a>
        </li>
      {% endfor %}
    {% endwith %}
  </ul>
{% endblock %}
