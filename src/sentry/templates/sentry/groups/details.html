{% extends "sentry/bases/stream.html" %}

{% load i18n %}
{% load sentry_activity %}
{% load sentry_api %}
{% load sentry_helpers %}
{% load sentry_plugins %}

{% block title %}{{ group.title }} | {{ block.super }}{% endblock %}

{% block controller %}GroupDetailsCtrl{% endblock %}

{% block page_header %}{% endblock %}

{% block wrapperclass %}sidebar-right{% endblock %}

{% block breadcrumb_inner %}
  {{ block.super }}
  <li class="truncate">{{ group.title }}</li>
{% endblock %}

{% block main %}
    {% handle_before_events request group %}

    <div id="blk_agg_details"></div>
    <script>
    $(function(){
      React.render(React.createFactory(AggregateDetails)({
        aggList: [{% serialize group %}],
        aggId: '{{ group.id }}',
        project: {% serialize project %},
        memberList: [],
        chart: true
      }), document.getElementById('blk_agg_details'));
    });
    </script>

    {% block inner %}
        {% with event|get_rendered_interfaces:request as interface_list %}
            <div class="box">
                <div class="box-header">
                    <h3>Activity</h3>
                </div>
                <div class="activity box-content with-padding" id="activity">
                    <div class="post-box">
                        <form class="add-note-form" method="POST" action=".">
                            {% csrf_token %}
                            <input type="hidden" name="o" value="note">
                            {{ add_note_form.text }}
                            <!-- <fieldset class="form-actions">
                                <button type="submit" class="btn btn-small btn-primary">{% trans "Add Note" %}</button>
                            </fieldset> -->
                        </form>
                    </div>
                    <ul>
                        {% for item in activity %}
                            {% with item|render_activity as out %}
                                {% if out %}
                                    <li class="item item-{{ item.get_type_display }}">{{ out }}</li>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="btn-toolbar event-toolbar">
                <!-- We switch the ordering of events here as it makes more sense visually -->
                <a class="btn btn-default btn-lg pull-left prev {% if not next_event %} disabled{% endif %}"{% if next_event %} href="{% url 'sentry-group-event' group.organization.slug group.project.slug group.id next_event.id %}"{% endif %}><span></span> {% trans "Newer Sample" %}</a>
                <a class="btn btn-default btn-lg pull-right next {% if not prev_event %} disabled{% endif %}"{% if prev_event %} href="{% url 'sentry-group-event' group.organization.slug group.project.slug group.id prev_event.id %}"{% endif %}>{% trans "Older Sample" %} <span></span></a>
                <h4>
                <span title="{{ event.datetime }}">{% localized_datetime event.datetime %}</span> [{{ event.size|filesizeformat }}]<br><small>ID: {{ event.event_id }}</small></h4>
            </div>

            {% if group.is_muted %}
                <div class="alert alert-info">This event has been muted. You will not be notified of any changes and it will not show up in the default feed.</div>
            {% endif %}

            {% if event.has_two_part_message %}
                <div class="box">
                  <div class="box-header">
                      <h3>{% trans "Full message" %}</h3>
                  </div>
                  <div class="box-content with-padding">
                    <pre id="full-message">{{ event.message }}</pre>
                  </div>
                </div>
            {% endif %}

            {% include "sentry/partial/_event_details.html" %}
        {% endwith %}
    {% endblock %}

{% endblock %}

{% block sidebar %}
    <ul class="nav nav-stacked hidden-xs">
        <li{% if page == 'details' %} class="active"{% endif %}><a href="{% url 'sentry-group' group.organization.slug group.project.slug group.id %}">Aggregate</a></li>
        <li{% if page == 'tag_list' %} class="active"{% endif %}>
            <a href="{% url 'sentry-group-tags' group.organization.slug group.project.slug group.id %}">{% trans "Tags" %}</a>
        </li>
        <li{% if page == 'event_list' or page == 'event' %} class="active"{% endif %}>
            <a href="{% url 'sentry-group-events' group.organization.slug group.project.slug group.id %}">{% trans "Samples" %}</a>
        </li>
    </ul>

    <div class="hidden-xs">
        <h6>{% trans "Aggregate Details" %}</h6>

        <dl class="flat">
            <dt>{% trans "Status:" %}</dt>
            <dd class="align-right">{{ group.get_status_display|title }}</dd>
            <dt>{% trans "First Seen:" %}</dt>
            <dd class="pretty-date align-right" data-datetime="{% localized_datetime group.first_seen "c" %}">{{ group.first_seen|timesince }}</dd>
            {% if group.active_at and group.active_at != group.first_seen %}
                <dt>{% trans "Reopened:" %}</dt>
                <dd class="pretty-date align-right" data-datetime="{% localized_datetime group.active_at "c" %}">{{ group.active_at|timesince }}</dd>
            {% endif %}
            <dt>{% trans "Last Seen:" %}</dt>
            <dd class="pretty-date align-right" data-datetime="{% localized_datetime group.last_seen "c" %}">{{ group.last_seen|timesince }}</dd>
            {% if group.avg_time_spent %}
                <dt>{% trans "Avg Duration:" %}</dt>
                <dd>{% if group.avg_time_spent %}{{ group.avg_time_spent|duration }}{% else %}<em>{% trans "n/a" %}</em>{% endif %}</dd>
            {% endif %}
        </dl>
    </div>

    <div class="hidden-xs">
      {% for tag in group.get_tags %}
          {% render_tag_widget group tag %}
      {% endfor %}
    </div>

    {% for html in group|get_widgets:request %}
        {{ html|safe }}
    {% endfor %}
{% endblock %}

{% block content_after %}
    <script>
    window.SentryConfig.selectedGroup = {% convert_to_json selectedGroup %};
    </script>
{% endblock %}
