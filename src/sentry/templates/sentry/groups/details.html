{% extends "sentry/bases/stream.html" %}

{% load i18n %}
{% load sentry_activity %}
{% load sentry_helpers %}
{% load sentry_plugins %}

{% block title %}{% if event %}{{ event.error }}{% else %}{{ group.message }}{% endif %} | {{ block.super }}{% endblock %}

{% block page_header %}{% endblock %}

{% block content_before %}
    <!-- <div id="details">
        <div id="event_list" class="inactive"></div>
    </div> -->

    <div class="group-detail">
      <div class="row">
          <div class="col-xs-8 details">
            <h3>Someone tickled my port</h3>
            <div class="meta">
                <time time-since="selectedGroup.lastSeen">2 days ago</time> &middot;
                <span class="message">And it felt so goooood</span>
            </div>
          </div>
          <div class="col-xs-4 occurrences">
            <div class="row">
              <div class="col-xs-4 assigned-to align-right">
                <div class="dropdown">
                    {% spaceless %}
                    <span class="avatar"><img src="http://github.com/benvinegar.png"></span> 
                    <a href="" class="btn btn-sm btn-default">
                        <span class="icon-arrow-down"></span>
                    </a>
                    {% endspaceless %}
                </div>
                <div style="clear: both">is assigned</div>
              </div>
              <div class="col-xs-4 occurences align-right"><span class="count">1000</span> events</div>
              <div class="col-xs-4 users align-right"><span class="count">209</span> users</div>
            </div>
          </div>
      </div>
      <div class="seen-by">
        <ul>
          <li>Seen by</li>
          <li ng-repeat="user in selectedGroup.seenBy">
            <a href="#"><img src="{{user.avatarUrl}}" /></a>
          </li>
          <li>
            <a href="#"><img src="http://github.com/ckj.png"></a>
          </li>
          <li>
            <a href="#"><img src="http://github.com/dcramer.png"></a>
          </li>
          <li>
            <a href="#"><img src="http://github.com/mattrobenolt.png"></a>
          </li>
        </ul>
      </div>
      <div class="group-actions">
        <div class="btn-group">
          <a href="#" class="btn btn-default btn-sm"><span class="icon-checkmark"></span></a>
          <a href="#" class="btn btn-default btn-sm"><span class="icon-bookmark"></span></a>
        </div>
        <div class="btn-group">
          <a href="#" class="btn btn-default btn-sm"><span class="icon-trash"></span></a>
        </div>
        <div class="btn-group">
          <a href="#" class="btn btn-default btn-sm">More <span class="icon-arrow-down"></span></a>
        </div>
      </div>
    </div>
{% endblock %}

{% block main %}
    {% handle_before_events request group %}

    {% block inner %}
        {% with event|get_rendered_interfaces:request as interface_list %}

            {% if group|has_charts %}
                <div class="box">
                    <div class="box-content with-padding">
                        <div id="chart" class="chart" data-api-url="{% url 'sentry-api-0-group-stats' group.id %}">
                            <div class="sparkline">
                                <span class="loading">{% trans "Loading historical data..." %}</span>
                                <noscript>{% trans "Get yourself some JavaScripts dood" %}</noscript>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <div class="box">
                <div class="box-header">
                    <h3>Activity</h3>
                </div>
                <div class="activity box-content with-padding" id="activity">
                    <div class="post-box">
                        <form class="add-note-form" method="POST" action=".">
                            {% csrf_token %}
                            <input type="hidden" name="o" value="note">
                            {{ add_note_form.text }}
                            <!-- <fieldset class="form-actions">
                                <button type="submit" class="btn btn-small btn-primary">{% trans "Add Note" %}</button>
                            </fieldset> -->
                        </form>
                    </div>
                    <ul>
                        {% for item in activity %}
                            {% with item|render_activity as out %}
                                {% if out %}
                                    <li class="item item-{{ item.get_type_display }}">{{ out }}</li>
                                {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </ul>
                </div>
            </div>

            <div class="btn-toolbar event-toolbar">
                <!-- We switch the ordering of events here as it makes more sense visually -->
                <a class="btn btn-default btn-lg pull-right prev {% if not next_event %} disabled{% endif %}"{% if next_event %} href="{% url 'sentry-group-event' group.team.slug group.project.slug group.id next_event.id %}"{% endif %}><span></span> {% trans "Newer Event" %}</a>
                <a class="btn btn-default btn-lg pull-left next {% if not prev_event %} disabled{% endif %}"{% if prev_event %} href="{% url 'sentry-group-event' group.team.slug group.project.slug group.id prev_event.id %}"{% endif %}>{% trans "Older Event" %} <span></span></a>
                <h4>
                Event at <span title="{{ event.datetime }}">{% localized_datetime event.datetime %}</span> [{{ event.size|filesizeformat }}]<br><small>ID: {{ event.event_id }}</small></h4>
            </div>
            {% comment %}
            {% include "sentry/partial/event_nav.html" %}
            {% endcomment %}

            {% if group.is_muted %}
                <div class="alert alert-info">This event has been muted. You will not be notified of any changes and it will not show up in the default feed.</div>
            {% endif %}

            {% if event.has_two_part_message %}
                <pre id="full-message">{{ event.message }}</pre>
            {% endif %}

            {% include "sentry/partial/_event_details.html" %}
        {% endwith %}
    {% endblock %}

{% endblock %}

{% block sidebar %}
    <ul class="nav nav-stacked">
        <li{% if page == 'details' %} class="active"{% endif %}><a href="{% url 'sentry-group' group.team.slug group.project.slug group.id %}">Aggregate</a></li>
        <li{% if page == 'tag_list' %} class="active"{% endif %}>
            <a href="{% url 'sentry-group-tags' group.team.slug group.project.slug group.id %}">{% trans "Tags" %}</a>
        </li>
        <li{% if page == 'event_list' or page == 'event' %} class="active"{% endif %}>
            <a href="{% url 'sentry-group-events' group.team.slug group.project.slug group.id %}">{% trans "Similar Events" %}</a>
        </li>
    </ul>

    <h6>{% trans "Aggregate Details" %}</h6>

    <dl class="flat">
        <dt>{% trans "Status:" %}</dt>
        <dd class="align-right">{{ group.get_status_display|title }}</dd>
        <dt>{% trans "First Seen:" %}</dt>
        <dd class="pretty-date align-right" data-datetime="{% localized_datetime group.first_seen "c" %}">{{ group.first_seen|timesince }}</dd>
        {% if group.active_at and group.active_at != group.first_seen %}
            <dt>{% trans "Reopened At:" %}</dt>
            <dd class="pretty-date" data-datetime="{% localized_datetime group.active_at "c" %}">{{ group.active_at|timesince }}</dd>
        {% endif %}
        <dt>{% trans "Last Seen:" %}</dt>
        <dd class="pretty-date align-right" data-datetime="{% localized_datetime group.last_seen "c" %}">{{ group.last_seen|timesince }}</dd>
        {% if group.avg_time_spent %}
            <dt>{% trans "Avg Duration:" %}</dt>
            <dd>{% if group.avg_time_spent %}{{ group.avg_time_spent|duration }}{% else %}<em>{% trans "n/a" %}</em>{% endif %}</dd>
        {% endif %}
    </dl>

    {% if seen_by_faces %}
        <h6>{% trans "Seen By" %}</h6>
        <ul class="seen-by">
            {% for s_user, s_last_seen in seen_by_faces %}
                <li>
                    <img src="{% gravatar_url s_user.email size 32 %}" class="tip" rel="tooltip" title="<strong>{{ s_user|user_display_name|force_escape }}</strong><br>{{ s_last_seen|timesince }}">
                </li>
            {% endfor %}
            {% if seen_by_extra %}
                <li class="tip" rel="tooltip" title="{% for s_user, _ in seen_by %}- {{ s_user|user_display_name|force_escape }}<br>{% endfor %}">
                    &middot;&middot;&middot;
                </li>
            {% endif %}
        </ul>
    {% endif %}

    <h6>{% trans "Actions" %}</h6>
    <ul class="nav nav-stacked">
        {% if can_admin_event %}
            {% if not group.is_muted %}
                <li><a href="{% url 'sentry-api-set-group-mute' group.team.slug project.slug group.id %}">{% trans "Mute Event" %}</a></li>
            {% elif not group.is_resolved %}
                <li><a href="{% url 'sentry-api-set-group-unresolve' group.team.slug project.slug group.id %}">{% trans "Unmute Event" %}</a></li>
            {% endif %}
            {% url 'sentry-group' group.team.slug group.project.slug group.id as group_link %}
            <li>
                <a href="javascript:void(0)"
                   data-public-url="{% url 'sentry-api-set-group-public' group.team.slug group.project.slug group.id %}"
                   data-private-url="{% url 'sentry-api-set-group-private' group.team.slug group.project.slug group.id %}"
                   data-share-url="{% absolute_uri group_link %}"
                   data-public="{% if group.is_public %}true{% else %}false{% endif %}"
                   class="share-link">{% trans "Share Event" %}</a>
            </li>
            {% for label, link, is_active in group|get_actions:request %}
                <li><a href="{{ link }}">{{ label }}</a></li>
            {% endfor %}
        {% endif %}
        <li><a {% if event.id %}
        href="{% url 'sentry-group-event-json' group.team.slug project.slug group.id event.id %}"{% else %}
        href="{% url 'sentry-group-event-json' group.team.slug project.slug group.id 'latest' %}"{% endif %}
        >{% trans "Raw JSON Data" %}</a></li>
        {% if can_admin_event %}
            <li><a href="{% url 'sentry-api-remove-group' group.team.slug project.slug group.id %}"
                   onclick="return confirm('{% trans "Are you sure you wish to delete all data for this event?" %}');">{% trans "Remove Event Data" %}</a></li>
        {% endif %}
    </ul>

    {% for tag in group.get_tags %}
        {% render_tag_widget group tag %}
    {% endfor %}

    {% for html in group|get_widgets:request %}
        {{ html|safe }}
    {% endfor %}
{% endblock %}

{% block content_after %}
    <script>
    require(['config', 'app/init'], function(_, app){
        new app.GroupDetailsPage({
            group: {{ group|to_json:request|safe }},
        });
    });
    </script>
{% endblock %}
