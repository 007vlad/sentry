{% extends "sentry/bases/stream.html" %}

{% load i18n %}
{% load sentry_helpers %}
{% load sentry_plugins %}

{% block controller %}ProjectStreamCtrl{% endblock %}

{% block main %}
    {% paginator event_list from request as event_list per_page EVENTS_PER_PAGE %}
    {% querystring from request without sort as sort_querystring %}
    {% querystring from request without since as since_querystring %}

    {% recent_alerts from project as recent_alerts %}
    {% if recent_alerts %}
        <ul class="active-alerts">
            {% for alert in recent_alerts %}
                <li class="alert alert-error">
                    <a class="close" data-dismiss="alert">Ã—</a>
                    <a href="{% url 'sentry-alert-details' project.team.slug project.slug alert.id %}">{{ alert.message }}</a>
                    <small>&mdash; {{ alert.datetime|timesince }}</small>
                </li>
            {% endfor %}
        </ul>
    {% endif %}

    <script>
    window.groupList = {% serialize event_list.paginator.objects %};
    </script>

    <section id="stream"><div class="row"><div id="main">
        <ul class="events">
            <li class="event event-header">
                <div class="row">
                    <div class="col-xs-8 col-md-10 col-lg-8 hidden-xs details">
                        <div class="checkbox">
                            <input type="checkbox">
                        </div>
                        <div class="btn-group">
                            <a href="#" class="btn btn-default btn-sm"><span class="icon-checkmark"></span></a>
                            <a href="#" class="btn btn-default btn-sm"><span class="icon-bookmark"></span></a>
                        </div>
                        <a href="#" class="btn btn-default btn-sm"><span class="icon-pause"></span></a>
                        <div class="btn-group">
                            <div class="btn-group">
                                <a class="btn btn-default btn-sm dropdown-toggle" data-toggle="dropdown">
                                    {% blocktrans with sort_label as label %}Sort by: {{ label }}{% endblocktrans %} <span class="icon-arrow-down"></span>
                                </a>
                                <ul class="dropdown-menu" role="menu">
                                    <li{% ifequal sort 'priority' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=priority">{{ SORT_OPTIONS.priority }}</a></li>
                                    <li{% ifequal sort 'date' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=date">{{ SORT_OPTIONS.date }}</a></li>
                                    <li{% ifequal sort 'new' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=new">{{ SORT_OPTIONS.new }}</a></li>
                                    <li{% ifequal sort 'freq' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=freq">{{ SORT_OPTIONS.freq }}</a></li>
                                    <li class="divider"></li>
                                    <li{% ifequal sort 'tottime' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=tottime">{{ SORT_OPTIONS.tottime }}</a></li>
                                    <li{% ifequal sort 'avgtime' %} class="active"{% endifequal %}><a href="?{{ sort_querystring }}&amp;sort=avgtime">{{ SORT_OPTIONS.avgtime }}</a></li>
                                </ul>
                            </div>
                            <div class="btn-group">
                                <a class="btn btn-default btn-sm dropdown-toggle"
                                   data-toggle="dropdown"
                                   onclick="$('#daterange').toggle(); return false;">
                                    {% if from_date %}
                                        {% if not to_date %}
                                            Since: {{ from_date|date:"M jS" }}
                                        {% else %}
                                            Between: {{ from_date|date:"M jS" }} <small>and</small> {{ to_date|date:"M jS" }}
                                        {% endif %}
                                    {% else %}
                                        {% if to_date %}
                                            Before: {{ to_date|date:"M jS" }}
                                        {% else %}
                                            Between: The Past <small>and</small> The Present
                                        {% endif %}
                                    {% endif %} <span class="icon-arrow-down"></span>
                                </a>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-2 hidden-md hidden-sm hidden-xs graph align-right">
                        <ul>
                            <li ng-class="{active: chartDuration=='1d'}"><a ng-click="setChartDuration('1d')">24h</a></li>
                            <li ng-class="{active: chartDuration=='14d'}"><a ng-click="setChartDuration('14d')">2w</a></li>
                            <li ng-class="{active: chartDuration=='30d'}"><a ng-click="setChartDuration('30d')">30d</a></li>
                        </ul>
                    </div>
                    <div class="col-sm-2 col-md-1 hidden-xs occurrences align-right">count</div>
                    <div class="col-sm-2 col-md-1 hidden-xs users align-right">users</div>
                </div>
            </li>
            <li class="event" ng-repeat="group in groupList">
                <div class="row">
                    <div class="col-xs-8 col-md-10 col-lg-8 details">
                        <div class="checkbox">
                            <input type="checkbox">
                        </div>
                        <h3><a href="<% group.permalink %>"><% group.title %></a></h3>
                        <div class="meta">
                            <time time-since="group.lastSeen"></time> &middot;
                            <span class="message"><% group.culprit %></span>
                        </div>
                    </div>
                    <div class="col-lg-2 hidden-md hidden-sm hidden-xs graph align-right">
                        <barchart ng-model="group.activeChartData" width="100%" height="37" style="display:block"></barchart>
                    </div>
                    <div class="col-sm-2 col-md-1 hidden-xs occurrences align-right"><span count="group.count"></span></div>
                    <div class="col-sm-2 col-md-1 hidden-xs users align-right"><span count="group.tags['sentry:user'].count"></span></div>
                </div>
            </li>
        </ul>

        <div class="stream-actions">
            <div class="btn-group pull-right">
                <a class="btn btn-default prev{% if not event_list.paginator.has_previous %} disabled{% else %}" href="?{{ event_list.query_string|escape }}&amp;p={{ event_list.paginator.previous_page }}{% endif %}"><span class="icon-arrow-left" title="{% trans "Previous" %}"></span></a>
                <a class="btn btn-default next{% if not event_list.paginator.has_next %} disabled{% else %}" href="?{{ event_list.query_string|escape }}&amp;p={{ event_list.paginator.next_page }}{% endif %}"><span class="icon-arrow-right" title="{% trans "Next" %}"></span></a>
            </div>
        </div>
    </div></div></section>

    <div class="btn-toolbar">
        <div class="btn-group">
            <a class="btn" href="javascript:void(0)" id="sentry-resolve-feed" onclick="Sentry.stream.clear('{{ project.slug }}');"><i aria-hidden="true" class="icon-checkmark"></i> {% trans "Resolve Feed" %}</a>
        </div>
        <div class="btn-group">
            <a class="btn realtime-play" data-action="pause" data-pause-label="{% trans "Pause Updates" %}" data-play-label="{% trans "Enable Updates" %}" href="javascript:void(0)">
                {% trans "Pause Updates" %}
            </a>
        </div>
    </div>

    <div class="datepicker-box" id="daterange">
        <form method="GET">
            {% for key, value in request.GET.iteritems %}
                {% if key != df and key != tf and key != dt and key != tt and key != page %}
                    <input type="hidden" name="{{ key }}" value="{{ value }}">
                {% endif %}
            {% endfor %}
            <div class="input">
              <div class="inline-inputs">
                <input data-toggle="datepicker" data-date-format="yyyy-mm-dd"name="df" class="date" type="text" value="{% if from_date %}{{ from_date|date:"Y-m-d" }}{% endif %}" />
                <input class="time" type="text" name="tf" value="{% if from_date %}{{ from_date|time:"h:i A" }}{% endif %}" />
                to
                <input data-toggle="datepicker" data-date-format="yyyy-mm-dd" name="dt" class="date" type="text" value="{% if to_date %}{{ to_date|date:"Y-m-d" }}{% endif %}" />
                <input class="time" type="text" name="tt" value="{% if to_date %}{{ to_date|time:"h:i A" }}{% endif %}" />
              </div>
              <div class="help-block">{% trans "All events are represented in UTC time." %}</div>
            </div>
            <div class="submit">
                <div class="pull-right">
                    <input type="button" class="btn btn-small" value="{% trans "Clear" %}" onclick="$('#daterange input[type=text]').val(''); this.form.submit();">
                    <input type="submit" class="btn btn-primary btn-small" value="{% trans "Apply" %}">
                </div>
                <div class="radio-inputs">
                    <label class="radio">
                        <input type="radio" name="date_type" value="last_seen" {% if date_type != 'first_seen' %}checked{% endif %}> {% trans "Last Seen" %}
                    </label>
                    <label class="radio">
                        <input type="radio" name="date_type" value="first_seen" {% if date_type == 'first_seen' %}checked{% endif %}> {% trans "First Seen" %}
                    </label>
                </div>
            </div>
        </form>
    </div>
{% endblock %}
