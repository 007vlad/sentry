{% extends "sentry/bases/modal.html" %}

{% load i18n %}

{% block title %}{% trans "Access Group Migration" %} | {{ block.super }}{% endblock %}

{% block inner %}
  <div class="page-header">
    <div class="pull-right">
      <a href="{% url 'sentry-organization-home' organization.id %}">Back to Organization Home</a>
    </div>
    <h2>{% trans "Access Group Migration" %}</h2>
  </div>

  {% if member_list %}
    <p>Below is a list of all members who are part of any access group within this organization. You'll need to select which team(s) they should gain access to. Alternatively you can choose to remove the user if they no longer need access.</p>

    <p>Note: Unlike access groups, organization membership cannot be restricted per-project. If you need to refine access to that level you should create additional teams and move to the projects where applicable.</p>

    <table class="table table-striped access-group-migration">
      <thead>
        <tr>
          <th>Member</th>
          <th style="width:100px;text-align:center">Projects</th>
          <th style="width:100px;text-align:center">Remove?</th>
        </tr>
      </thead>
      {% for member, project_list in member_list %}
        <tr>
          <td>
            <h4>{{ member.get_display_name }}</h4>
            <label class="checkbox">
              <input type="checkbox" name="user[{{ user.id }}][global_access]" value="1" class="checkboxinput global-access">
              <strong>All Teams</strong>
            </label>
            <fieldset class="team-choices">
              {% for team in team_list %}
                <label class="checkbox">
                  <input type="checkbox" name="user[{{ user.id }}][team]" value="{{ team.slug }}" class="checkboxinput">
                  {{ team.slug }}
                </label>
              {% endfor %}
            </fieldset>
          </td>
          <td style="text-align:center;vertical-align:top">
            <a class="tip" title="{% for project in project_list %}{{ project.team.slug }} / {{ project.slug }}<br>{% endfor %}">{{ project_list|length }} project(s)</a>
          </td>
          <td style="text-align:center;vertical-align:top">
            <input type="checkbox" name="user[{{ user.id }}][remove]" value="1" class="checkboxinput">
          </td>
        </tr>
      {% endfor %}
    </table>
  {% else %}
    <p>Your work is done here! There are no access groups which need migrated.</p>
  {% endif %}

  <style>
  table.access-group-migration td,
  table.access-group-migration th {
    padding: 8px;
  }
  .access-group-migration td > h4 {
    margin-bottom: 10px;
    display: block;
  }
  .access-group-migration fieldset {
    margin-left: 20px;
  }
  .access-group-migration label {
    font-weight: normal;
  }
  </style>

  <script>
  $(function(){
    var selectedTeams = [];
    $('input.global-access').change(function(){
      var $this = $(this);
      var $parent = $this.parent().parent();
      var checked = $this.is(':checked');
      var selector = $parent.find('.team-choices input[type=checkbox]');

      if (checked) {
        selectedTeams = $parent.find('.team-choices input[type=checkbox]:checked').slice(0, selector.length);
        selector.prop('checked', true);
      } else {
        selector.prop('checked', false);
        $(selectedTeams).prop('checked', true);
        selectedTeams = [];
      }

      $('.team-choices').prop('disabled', checked);

    }).change();
  });
  </script>

{% endblock %}
